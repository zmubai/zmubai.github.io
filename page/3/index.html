<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta name="google-site-verification" content="xdxP4Om7Pxp3OMC73kRMv2emRoA91RXOEPaKMivB_zg" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="知行合一">
<meta property="og:type" content="website">
<meta property="og:title" content="沐白的个人博客">
<meta property="og:url" content="https://zengbailiang.cn/page/3/index.html">
<meta property="og:site_name" content="沐白的个人博客">
<meta property="og:description" content="知行合一">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="沐白的个人博客">
<meta name="twitter:description" content="知行合一">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zengbailiang.cn/page/3/"/>





  <title> Hexo, NexT - 沐白的个人博客知行合一 </title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">沐白的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-05-12-01.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-05-12-01.html" itemprop="url">iOS 指纹解锁 检测指纹信息变更</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-09T00:00:00+08:00">
                2018-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index">
                    <span itemprop="name">blog</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-05-12-01.html" class="leancloud_visitors" data-flag-title="iOS 指纹解锁 检测指纹信息变更">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,303
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通过LAContext evaluatedPolicyDomainState属性可以获取到当前data类型的指纹信息数据，当指纹增加或者删除，该data就会发生变化，通过记录这个TouchIdData与最新的data做对比就能判断指纹信息是否变更，从而定制app功能。</p>
<h3 id="存在的疑问："><a href="#存在的疑问：" class="headerlink" title="存在的疑问："></a>存在的疑问：</h3><ol>
<li>TouchIdData可能为空吗？<br>官方文档说明：<blockquote>
<p>Discussion<br>This property returns a value only when the canEvaluatePolicy(<em>:error:) method succeeds for a biometric policy or the evaluatePolicy(</em>:localizedReason:reply:) method is called and a successful biometric authentication is performed. Otherwise, nil is returned.<br>只有当canEvaluatePolicy方法执行并返回YES或者evaluatePolicy执行并指纹识别通过，这个属性才能有值，否则为空。</p>
</blockquote>
</li>
<li>TouchIdData能否获取具体的指纹信息？<blockquote>
<p>The returned data is an opaque structure. It can be used to compare with other values returned by this property to determine whether the authorized database has been updated. However, the nature of the change cannot be determined from this data.<br>返回的数据是一个不透明的结构。它可以用来与此属性返回的其他值进行比较，以确定是否更新了授权数据库。然而，变化的性质不能从这些数据中确定。</p>
</blockquote>
</li>
</ol>
<ol start="3">
<li>在指纹信息没有修改的时候，不同app获取到的TouchIdData是一样的吗?<br>实测不同的app，在指纹没有变化的情况下TouchIdData是不一样的。但这个是不能打包票的，如果苹果修改了这部分的算法，返回一个相同值也是有可能的。</li>
</ol>
<ol start="4">
<li>添加一个新指纹，再删除刚添加的那个指纹，TouchIdData相对一轮操作之前变化了吗？<br>实测TouchIdData没有变化，也就是说TouchIdData是面向结果的，而不是面向过程的，只要最终结果指纹集合一样，TouchIdData就一样。</li>
</ol>
<p>代码实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">    static var IDENTIFY:String? = nil</span><br><span class="line">    static let SERVICE = &quot;TOUCHID_SERVICE&quot;</span><br><span class="line">    static let ACCOUNT_PREFIX = &quot;TOUCHID_PERFIX&quot;</span><br><span class="line">    open class func setCurrentTouchIdDataIdentity(identity:String )</span><br><span class="line">    &#123;</span><br><span class="line">        //设定当前身份用于存储data</span><br><span class="line">        TouchIdManager.IDENTIFY = identity</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">//获取当前时刻的data</span><br><span class="line">  class func currentOriTouchIdData() -&gt; Data?&#123;</span><br><span class="line">        let context = LAContext()</span><br><span class="line">        var error:NSError? = nil;</span><br><span class="line">//先使用canEvaluatePolicy方法进行评估</span><br><span class="line">        if context.canEvaluatePolicy(LAPolicy.deviceOwnerAuthenticationWithBiometrics, error: &amp;error) &#123;</span><br><span class="line">            </span><br><span class="line">            return context.evaluatedPolicyDomainState</span><br><span class="line">        &#125;</span><br><span class="line">        print(&quot;errorMsg:&quot; + self.errorMessageForFails(errorCode:(error?.code)! ))</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//使用keychain保存当前身份的data</span><br><span class="line">open class func setCurrentIdentityTouchIdData()-&gt; Bool</span><br><span class="line">    &#123;</span><br><span class="line">        if self.currentTouchIdDataIdentity() == nil</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            if self.currentOriTouchIdData() != nil</span><br><span class="line">            &#123;</span><br><span class="line">                //storage by keychain</span><br><span class="line">                SAMKeychain.setPasswordData(self.currentOriTouchIdData()!, forService:SERVICE, account: ACCOUNT_PREFIX + self.currentTouchIdDataIdentity()!)</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//获取当前身份的上一次存储的data，用于对比</span><br><span class="line"> class func currentIdentityTouchIdData()-&gt;Data?</span><br><span class="line">    &#123;</span><br><span class="line">        guard (self.currentTouchIdDataIdentity() != nil) else &#123;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return  SAMKeychain.passwordData(forService: TouchIdManager.SERVICE, account: TouchIdManager.ACCOUNT_PREFIX + self.currentTouchIdDataIdentity()!)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//检测以这个身份设置开始到当前时刻指纹信息是否变更</span><br><span class="line">open class func touchIdInfoDidChange()-&gt;Bool</span><br><span class="line">    &#123;</span><br><span class="line">        let data = self.currentOriTouchIdData()</span><br><span class="line">        if data == nil &amp;&amp; self.isErrorTouchIDLockout() &#123;</span><br><span class="line">            //lock after unlock failed many times,and the fingerprint is not changed.</span><br><span class="line">            return false</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            let oldData = self.currentIdentityTouchIdData()</span><br><span class="line">            </span><br><span class="line">            if oldData == nil</span><br><span class="line">            &#123;</span><br><span class="line">                //never set</span><br><span class="line">                return false</span><br><span class="line">            &#125;</span><br><span class="line">            else if oldData == data</span><br><span class="line">            &#123;</span><br><span class="line">                //not change</span><br><span class="line">                return false</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                return true</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//检测当前是否为biometryLockout状态</span><br><span class="line">    class func isErrorTouchIDLockout()-&gt;Bool</span><br><span class="line">    &#123;</span><br><span class="line">        let context = LAContext()</span><br><span class="line">        var error:NSError?</span><br><span class="line">        context.canEvaluatePolicy(LAPolicy.deviceOwnerAuthenticationWithBiometrics, error: &amp;error)</span><br><span class="line">        </span><br><span class="line">        guard error != nil else &#123;</span><br><span class="line">            return false</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if error!.code == LAError.biometryLockout.rawValue &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            return false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="指纹识别的两种LAPolicy："><a href="#指纹识别的两种LAPolicy：" class="headerlink" title="指纹识别的两种LAPolicy："></a>指纹识别的两种LAPolicy：</h3><ul>
<li>deviceOwnerAuthenticationWithBiometrics<br>这个类型不能弹出密码解锁界面，但能更精准的反馈用户操作的状态：如指纹识别三次失败等。</li>
<li>deviceOwnerAuthentication<br>对识别行为的结果做了简化，无法判断具体状态。但能弹出密码解锁界面。<br>结合两者可以使指纹解锁做的更友善一点。</li>
<li>最终效果[正常流程]：指纹识别错误三次回调失败-&gt;再点击再识别错误两次-&gt;弹出密码解锁界面-&gt;密码错误5次-&gt;锁定1分钟-&gt;再输错-&gt;锁定五分钟。</li>
</ul>
<p>代码实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">open class func showTouchId(title:String,fallbackTitle:String?, fallbackBlock:TouchIdFallBackBlokc?,resultBlock:TouchIdResultBlock?)</span><br><span class="line">   &#123;</span><br><span class="line">       let context = LAContext();</span><br><span class="line">       context.localizedFallbackTitle = fallbackTitle</span><br><span class="line">       var useableError:NSError?</span><br><span class="line">       if context.canEvaluatePolicy(LAPolicy.deviceOwnerAuthenticationWithBiometrics, error: &amp;useableError) &#123;</span><br><span class="line">           context.evaluatePolicy(LAPolicy.deviceOwnerAuthenticationWithBiometrics, localizedReason: title) &#123; (success, error) in</span><br><span class="line">               DispatchQueue.main.async &#123;</span><br><span class="line">                   if success</span><br><span class="line">                   &#123;</span><br><span class="line">                       if resultBlock != nil</span><br><span class="line">                       &#123;</span><br><span class="line">                           resultBlock!(true,success,error)</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   else</span><br><span class="line">                   &#123;</span><br><span class="line">                       guard let error = error else</span><br><span class="line">                       &#123;</span><br><span class="line">                           return;</span><br><span class="line">                       &#125;</span><br><span class="line">                       </span><br><span class="line">                       print(&quot;errorMsg:&quot; + self.errorMessageForFails(errorCode: error._code))</span><br><span class="line">                       </span><br><span class="line">                       if error._code == LAError.userFallback.rawValue</span><br><span class="line">                       &#123;</span><br><span class="line">                           if fallbackBlock != nil</span><br><span class="line">                           &#123;</span><br><span class="line">                               fallbackBlock!()</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       else if error._code == LAError.biometryLockout.rawValue</span><br><span class="line">                       &#123;</span><br><span class="line">                           //try to show password interface</span><br><span class="line">                           self.tryShowTouchIdOrPwdInterface(title: title, resultBlock: resultBlock)</span><br><span class="line">                       &#125;</span><br><span class="line">                       else</span><br><span class="line">                       &#123;</span><br><span class="line">                           if resultBlock != nil</span><br><span class="line">                           &#123;</span><br><span class="line">                               resultBlock!(true,success,error)</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       else</span><br><span class="line">       &#123;</span><br><span class="line">           print(&quot;errorMsg:&quot; + self.errorMessageForFails(errorCode:(useableError?.code)! ))</span><br><span class="line">           </span><br><span class="line">           if useableError?.code == LAError.biometryLockout.rawValue</span><br><span class="line">           &#123;</span><br><span class="line">               //try to show password interface</span><br><span class="line">               self.tryShowTouchIdOrPwdInterface(title: title, resultBlock: resultBlock)</span><br><span class="line">           &#125;</span><br><span class="line">           else</span><br><span class="line">           &#123;</span><br><span class="line">               if resultBlock != nil</span><br><span class="line">               &#123;</span><br><span class="line">                   resultBlock!(false,false,useableError)</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   class func tryShowTouchIdOrPwdInterface(title:String,resultBlock:TouchIdResultBlock?)</span><br><span class="line">   &#123;</span><br><span class="line">       let context = LAContext();</span><br><span class="line">       context.localizedFallbackTitle = &quot;&quot;</span><br><span class="line">       var useableError:NSError?</span><br><span class="line">       if context.canEvaluatePolicy(LAPolicy.deviceOwnerAuthentication, error: &amp;useableError) &#123;</span><br><span class="line">           context.evaluatePolicy(LAPolicy.deviceOwnerAuthentication, localizedReason: title) &#123; (success, error) in</span><br><span class="line">               </span><br><span class="line">               DispatchQueue.main.async &#123;</span><br><span class="line">                   if resultBlock != nil</span><br><span class="line">                   &#123;</span><br><span class="line">                       resultBlock!(true,success,error)</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               guard let error = error else</span><br><span class="line">               &#123;</span><br><span class="line">                   return;</span><br><span class="line">               &#125;</span><br><span class="line">               print(&quot;errorMsg:&quot; + self.errorMessageForFails(errorCode: error._code))</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       else</span><br><span class="line">       &#123;</span><br><span class="line">           print(&quot;errorMsg:&quot; + self.errorMessageForFails(errorCode:(useableError?.code)! ))</span><br><span class="line">           </span><br><span class="line">           if resultBlock != nil</span><br><span class="line">           &#123;</span><br><span class="line">               resultBlock!(false,false,useableError)</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>测试demo:     </p>
<p>swift:<a href="https://github.com/zmubai/TouchIDTest-swift" target="_blank" rel="noopener">https://github.com/zmubai/TouchIDTest-swift</a></p>
<p>object-c:<a href="https://github.com/zmubai/TouchIDTest-OC" target="_blank" rel="noopener">https://github.com/zmubai/TouchIDTest-OC</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-05-09-011.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-05-09-011.html" itemprop="url">数组实现循环队列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-09T00:00:00+08:00">
                2018-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-05-09-011.html" class="leancloud_visitors" data-flag-title="数组实现循环队列">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  991
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>循环队列作为一种常用的数据结构，它使头尾指针能够灵活的在容器头尾跳跃，实现循环存取的结构。线性队列，在不移动元素的情况下，随着数据的不断读写，会出现假上溢的情况（当尾部指针已经到了容器底部，线性队列就无法插入了，尽管存在已出队列的可以空间，），导致已出队列的可用空间无法再被利用。另外循环队列很适合作为缓存的处理。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"></span><br><span class="line">  CycleQueue.m</span><br><span class="line">  CycleQueue</span><br><span class="line"></span><br><span class="line">  Created by zengbailiang on 2018/5/8.</span><br><span class="line">  Copyright © 2018年 zengbailiang. All rights reserved.</span><br><span class="line">  循环队列</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">#import &quot;CycleQueue.h&quot;</span><br><span class="line"></span><br><span class="line">#define CYCLE_QUEUE_MAX_SIZE 10</span><br><span class="line">#define CYCLE_QUEUE_ELEMENT int</span><br><span class="line"></span><br><span class="line">typedef struct kSCycleQueue</span><br><span class="line">&#123;</span><br><span class="line">    CYCLE_QUEUE_ELEMENT data[CYCLE_QUEUE_MAX_SIZE];</span><br><span class="line">    int fornt ,rear;</span><br><span class="line">&#125;*SCycleQueue;</span><br><span class="line"></span><br><span class="line">@implementation CycleQueue</span><br><span class="line"></span><br><span class="line">int queueInit(SCycleQueue *queue)</span><br><span class="line">&#123;</span><br><span class="line">    if ((*queue) == NULL) &#123;</span><br><span class="line">        (*queue) = (SCycleQueue)malloc(sizeof(struct kSCycleQueue));</span><br><span class="line"></span><br><span class="line">        /*初始化队列头和队列尾部，队列尾初始化为-1是为了添加原始的时候统一操作为后移*/</span><br><span class="line"></span><br><span class="line">        (*queue)-&gt;fornt = 0;</span><br><span class="line">        (*queue)-&gt;rear = -1;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool canAdd(SCycleQueue *queue)</span><br><span class="line">&#123;</span><br><span class="line">    if((*queue) == NULL</span><br><span class="line">       ||(*queue)-&gt;fornt + (*queue) -&gt;rear + 1 == CYCLE_QUEUE_MAX_SIZE</span><br><span class="line">       ||((*queue)-&gt;rear != -1 &amp;&amp;  (*queue)-&gt;rear + 1 == (*queue)-&gt;fornt))</span><br><span class="line">    &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int add(SCycleQueue *queue,CYCLE_QUEUE_ELEMENT e)</span><br><span class="line">&#123;</span><br><span class="line">    if (canAdd(queue)) &#123;</span><br><span class="line">        /*如果已经是在最后一个原始，那么跳到第0个原始添加，实现循环*/</span><br><span class="line">        if ((*queue) -&gt; rear == CYCLE_QUEUE_MAX_SIZE - 1) &#123;</span><br><span class="line">            (*queue) -&gt; rear = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            /*非最后一个元素后移即可*/</span><br><span class="line">            (*queue) -&gt; rear += 1;</span><br><span class="line">        &#125;</span><br><span class="line">        /*队尾添加元素*/</span><br><span class="line">        (*queue) -&gt;data[(*queue) -&gt;rear] = e;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int delete(SCycleQueue *queue,CYCLE_QUEUE_ELEMENT *e)</span><br><span class="line">&#123;</span><br><span class="line">    if ((*queue) == NULL) &#123;</span><br><span class="line">        return  -1;</span><br><span class="line">    &#125;</span><br><span class="line">    /*如果rear不等于-1就代表存在元素*/</span><br><span class="line">    else if((*queue)-&gt;fornt == 0 &amp;&amp; (*queue)-&gt;rear == -1)</span><br><span class="line">    &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        (*e) = (*queue)-&gt;data[(*queue)-&gt;fornt];</span><br><span class="line">        (*queue)-&gt;data[(*queue)-&gt;fornt] = -1;</span><br><span class="line">        /*如果 fornt == rear，代表最后一个元素了，这个时候把标记复位用于上面的判断。*/</span><br><span class="line">        if ((*queue)-&gt;fornt == (*queue)-&gt;rear) &#123;</span><br><span class="line">            (*queue)-&gt;fornt = 0;</span><br><span class="line">            (*queue)-&gt;rear = -1;</span><br><span class="line">        &#125;</span><br><span class="line">        else if((*queue)-&gt;fornt == CYCLE_QUEUE_MAX_SIZE - 1)</span><br><span class="line">        &#123;</span><br><span class="line">            /*如果是最后一个元素出队列，那么队列头跳到容器第一个元素实现循环出队列*/</span><br><span class="line">            (*queue)-&gt;fornt = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            (*queue)-&gt;fornt += 1;</span><br><span class="line">        &#125;</span><br><span class="line">      return 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)testt</span><br><span class="line">&#123;</span><br><span class="line">    test();</span><br><span class="line">    test1();</span><br><span class="line">    test2();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void test()</span><br><span class="line">&#123;</span><br><span class="line">    SCycleQueue queue;</span><br><span class="line">    queueInit(&amp;queue);</span><br><span class="line">    add(&amp;queue, 0);</span><br><span class="line">    add(&amp;queue, 1);</span><br><span class="line">    add(&amp;queue, 2);</span><br><span class="line">    add(&amp;queue, 3);</span><br><span class="line">    add(&amp;queue, 4);</span><br><span class="line">    add(&amp;queue, 5);</span><br><span class="line">    add(&amp;queue, 6);</span><br><span class="line">    add(&amp;queue, 7);</span><br><span class="line">    add(&amp;queue, 8);</span><br><span class="line">    /*加满*/</span><br><span class="line">    add(&amp;queue, 9);</span><br><span class="line">    CYCLE_QUEUE_ELEMENT e;</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    /*容器底部已满，循环到头部开始添加*/</span><br><span class="line">    add(&amp;queue, 10);</span><br><span class="line">    add(&amp;queue, 11);</span><br><span class="line">    add(&amp;queue, 12);</span><br><span class="line">    add(&amp;queue, 13);</span><br><span class="line">    add(&amp;queue, 14);</span><br><span class="line">&#125;</span><br><span class="line">void test1()</span><br><span class="line">&#123;</span><br><span class="line">    SCycleQueue queue;</span><br><span class="line">    queueInit(&amp;queue);</span><br><span class="line">    add(&amp;queue, 0);</span><br><span class="line">    add(&amp;queue, 1);</span><br><span class="line">    add(&amp;queue, 2);</span><br><span class="line">    add(&amp;queue, 3);</span><br><span class="line">    add(&amp;queue, 4);</span><br><span class="line">    add(&amp;queue, 5);</span><br><span class="line">    add(&amp;queue, 6);</span><br><span class="line">    add(&amp;queue, 7);</span><br><span class="line">    add(&amp;queue, 8);</span><br><span class="line">    add(&amp;queue, 9);</span><br><span class="line">    CYCLE_QUEUE_ELEMENT e;</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    /*全部出队列，标记复位*/</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    add(&amp;queue, 6);</span><br><span class="line">    add(&amp;queue, 7);</span><br><span class="line">    add(&amp;queue, 8);</span><br><span class="line">    add(&amp;queue, 9);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void test2()</span><br><span class="line">&#123;</span><br><span class="line">    SCycleQueue queue;</span><br><span class="line">    queueInit(&amp;queue);</span><br><span class="line">    add(&amp;queue, 0);</span><br><span class="line">    add(&amp;queue, 1);</span><br><span class="line">    add(&amp;queue, 2);</span><br><span class="line">    add(&amp;queue, 3);</span><br><span class="line">    add(&amp;queue, 4);</span><br><span class="line">    add(&amp;queue, 5);</span><br><span class="line">    add(&amp;queue, 6);</span><br><span class="line">    add(&amp;queue, 7);</span><br><span class="line">    add(&amp;queue, 8);</span><br><span class="line">    add(&amp;queue, 9);</span><br><span class="line">    CYCLE_QUEUE_ELEMENT e;</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line"></span><br><span class="line">    /*font = 5*/</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    add(&amp;queue, 15);</span><br><span class="line">    add(&amp;queue, 16);</span><br><span class="line">    add(&amp;queue, 11);</span><br><span class="line">    add(&amp;queue, 12);</span><br><span class="line">    add(&amp;queue, 13);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line"></span><br><span class="line">    /*循环到容器头出队列*/</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">    delete(&amp;queue, &amp;e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-05-05-01.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-05-05-01.html" itemprop="url">git的文件系统与底层原理 (1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-05T00:00:00+08:00">
                2018-05-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/git/" itemprop="url" rel="index">
                    <span itemprop="name">git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-05-05-01.html" class="leancloud_visitors" data-flag-title="git的文件系统与底层原理 (1)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,102
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> 由于工作中使用git作为版本管理，之前对git的了解不多，特别是底层方面的原理方面的知识。为了能更好的使用git，有必要学习并梳理下相关知识。</p>
<p>步入正题：</p>
<h3 id="git的文件结构"><a href="#git的文件结构" class="headerlink" title="git的文件结构"></a>git的文件结构</h3><p>执行git init 初始化后，会在.git文件夹下会创建多个目录，每个文件夹功能划分的很清晰。<br><img src="https://upload-images.jianshu.io/upload_images/1690665-6458ddc5b28b057a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/720" alt="git目录结构.png"></p>
<h3 id="git的存储方式"><a href="#git的存储方式" class="headerlink" title="git的存储方式"></a>git的存储方式</h3><p>Git 是一套内容寻址文件系统.通过键值对的方式存储和查找。</p>
<p>下面操作一遍，直观的看到整个过程，以便理解。</p>
<h5 id="首先，创建一个内容对象"><a href="#首先，创建一个内容对象" class="headerlink" title="首先，创建一个内容对象"></a>首先，创建一个内容对象</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;小明的文件&quot; | git hash-object -w --stdin</span><br><span class="line">5c98f8a9221e5336f68c7575cd238b48875137c6</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th>命令/参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>     echo</td>
<td>将字符串输出到终端</td>
<td></td>
</tr>
<tr>
<td>     git hash-object</td>
<td>创建一个blob（二进制大对象）,<br>可指定其他类型，不一定是blob。</td>
<td></td>
</tr>
<tr>
<td>     –stdin</td>
<td>从标准终端中读取输入，代替从文件读取，<br>这里读取的是由echo命令输出到终端的字符串。</td>
<td></td>
</tr>
<tr>
<td></td>
<td>-w</td>
<td>把blob对象写入数据库</td>
<td></td>
</tr>
</tbody>
</table>
<p>参考：<a href="https://git-scm.com/docs/git-hash-object" target="_blank" rel="noopener">https://git-scm.com/docs/git-hash-object</a></p>
<h5 id="查看刚才存储的数据"><a href="#查看刚才存储的数据" class="headerlink" title="查看刚才存储的数据"></a>查看刚才存储的数据</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ find .git/objects -type f</span><br><span class="line">.git/objects/5c/98f8a9221e5336f68c7575cd238b48875137c6</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th>命令/参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>find</td>
<td>查找目录下文件</td>
<td></td>
</tr>
<tr>
<td>-type f</td>
<td>指定查类型为普通文件</td>
<td></td>
</tr>
</tbody>
</table>
<p>参考：<a href="http://man.linuxde.net/find" target="_blank" rel="noopener">http://man.linuxde.net/find</a></p>
<p>可以见到文件名称为数字和字母组成的字符串。这个是根据文件内容和头信息（Header），通过SHA-1算法计算得出的40位十六进制校验和。</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>校验和</td>
<td>5c98f8a9221e5336f68c7575cd238b48875137c6</td>
<td></td>
</tr>
<tr>
<td>存储路径</td>
<td>5c/98f8a9221e5336f68c7575cd238b48875137c6<br>以校验和前两位作为子路径创建文件夹，<br>以校验和后38位作为文件名生成文件。</td>
<td></td>
</tr>
</tbody>
</table>
<p><em>SHA-1是一种加密哈希函数（cryptographic hash function）。SHA-1将文件中的内容通过其hash算法生成一个160bit的报文摘要，即40个十六进制数字（每个十六进制数字占4位）。它几乎可以保证，如果两个文件的SHA-1值是相同的，那么它们确是完全相同的内容（类似于生活中的指纹识别）；SHA-1主要有两种用途，一个是加密，一个是数据完整性校验。Linux kernel开创者和Git的开发者——Linus说，Git使用了SHA-1并非是为了安全性，而是为了数据的完整性。理论上SHA-1会在2^51攻击下实现哈希碰撞，所以也不是完全的安全。</em></p>
<h5 id="通过校验和作为键值-解读文件"><a href="#通过校验和作为键值-解读文件" class="headerlink" title="通过校验和作为键值 解读文件"></a>通过校验和作为键值 解读文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p 5c98f8a9221e5336f68c7575cd238b48875137c6</span><br><span class="line">小明的文件</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th>命令/参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>git cat-file</td>
<td>读取对象信息</td>
<td></td>
</tr>
<tr>
<td>-p</td>
<td>根据对象的类型打印其信息</td>
<td></td>
</tr>
</tbody>
</table>
<p>参考：<a href="https://git-scm.com/docs/git-cat-file" target="_blank" rel="noopener">https://git-scm.com/docs/git-cat-file</a></p>
<p>以上，说明了git的数据存储的基本方式。主要是使用SHA-1算法根据其内容和头信息生成唯一的40位校验和，并使用校验和作为key做文件存取。</p>
<p>模拟bolb对象存储流程<br><img src="https://upload-images.jianshu.io/upload_images/1690665-a9e4427dc58379b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="bolb存储流程图.png"></p>
<p>以上，说明了git的数据存储的基本方式。主要步骤：</p>
<ol>
<li>使用SHA-1算法根据其原始内容和头信息（头信息格式”blob #{content.length}\0”）生成唯一的40位校验和。</li>
<li>以校验和前两位创建文件夹、校验和后38位作为文件名。</li>
<li>对拼接后的内容压缩后存储。        </li>
</ol>
<hr>
<p>下面是创建文件，修改文件，恢复文件的相关过程。</p>
<h5 id="重新创建一个仓库并创建一个文件"><a href="#重新创建一个仓库并创建一个文件" class="headerlink" title="重新创建一个仓库并创建一个文件"></a>重新创建一个仓库并创建一个文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo &apos;小明该吃午饭了&apos; &gt; test.txt</span><br><span class="line">$ git hash-object -w test.txt</span><br><span class="line">efbd70f46da0d1852de88c58aebc86616beecdaf</span><br></pre></td></tr></table></figure>
<h5 id="修改文件再保存"><a href="#修改文件再保存" class="headerlink" title="修改文件再保存"></a>修改文件再保存</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;小明打算去吃个泡面&quot; &gt; test.txt</span><br><span class="line">$ git hash-object -w test.txt</span><br><span class="line">26aab56c7d1f9bd962b28f78ce61f021b221d317</span><br></pre></td></tr></table></figure>
<h5 id="查看已保存的内容"><a href="#查看已保存的内容" class="headerlink" title="查看已保存的内容"></a>查看已保存的内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find .git/objects -type f</span><br><span class="line">.git/objects/26/aab56c7d1f9bd962b28f78ce61f021b221d317</span><br><span class="line">.git/objects/ef/bd70f46da0d1852de88c58aebc86616beecdaf</span><br></pre></td></tr></table></figure>
<h5 id="恢复到第一个版本"><a href="#恢复到第一个版本" class="headerlink" title="恢复到第一个版本"></a>恢复到第一个版本</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p efbd70f46da0d1852de88c58aebc86616beecdaf &gt; .git/test.txt</span><br><span class="line">$ cat .git/test.txt</span><br><span class="line">小明该吃午饭了</span><br></pre></td></tr></table></figure>
<p>git会记录每个版本的修改，根据校验和可恢复到相应的版本。</p>
<hr>
<p><strong>小结：</strong>这个过程中包括文件创建、文件修改、文件恢复，跟我们平时工作中使用的高级命令功能很相似。git会把整个过程转化为底层操作，同时对用户透明。</p>
<p><strong>相关引用参考：</strong></p>
<p><a href="http://smilejay.com/2012/08/git-commit-sha-1/" target="_blank" rel="noopener">http://smilejay.com/2012/08/git-commit-sha-1/</a></p>
<p><a href="https://git-scm.com/book/zh/v1/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Git-%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener">https://git-scm.com/book/zh/v1/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Git-%E5%AF%B9%E8%B1%A1</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-04-23-0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-04-23-0.html" itemprop="url">git 常用操作汇总</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-23T00:00:00+08:00">
                2018-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/git/" itemprop="url" rel="index">
                    <span itemprop="name">git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-04-23-0.html" class="leancloud_visitors" data-flag-title="git 常用操作汇总">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  869
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="说明-默认在master分支、远程分支origin，-省略分支名称"><a href="#说明-默认在master分支、远程分支origin，-省略分支名称" class="headerlink" title="说明(默认在master分支、远程分支origin， 省略分支名称)"></a>说明(默认在master分支、远程分支origin， 省略分支名称)</h4><p><img src="https://upload-images.jianshu.io/upload_images/1690665-c6ce334a8505da19.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="gitRebase.png"></p>
<h6 id="配置本地信息"><a href="#配置本地信息" class="headerlink" title="配置本地信息"></a>配置本地信息</h6><pre><code>git cogfig --global user.name userName   
git config --global user.email userEmail    
</code></pre><h6 id="克隆远程仓库"><a href="#克隆远程仓库" class="headerlink" title="克隆远程仓库"></a>克隆远程仓库</h6><pre><code>git clone remotePath     
</code></pre><p>如：git clone <a href="https://github.com/yourname/test.git" target="_blank" rel="noopener">https://github.com/yourname/test.git</a> </p>
<h6 id="本地推送到远程仓库"><a href="#本地推送到远程仓库" class="headerlink" title="本地推送到远程仓库"></a>本地推送到远程仓库</h6><pre><code>git  remote add origin remotePath   [绑定远程仓库]   
git push -u origin master [推送到远程master分支]    
</code></pre><h6 id="本地提交"><a href="#本地提交" class="headerlink" title="本地提交"></a>本地提交</h6><pre><code>git status [显示工作区变更]   
git add finePath [把单个文件添加到暂存区]   
git commit -m &quot;log&quot; [提交到本地分支]   
git commit -am &quot;log&quot; [提交到本地分支，包含add操作]   
</code></pre><h6 id="显示文件修改"><a href="#显示文件修改" class="headerlink" title="显示文件修改"></a>显示文件修改</h6><pre><code>git diff finePath [工作区文件与暂存区文件对比]  
git diff finePath --cached [暂存区文件与当前版本文件对比]  
参考：https://www.jianshu.com/p/80542dc3164e
</code></pre><h6 id="本地分支处理"><a href="#本地分支处理" class="headerlink" title="本地分支处理"></a>本地分支处理</h6><pre><code>git branch -a [显示本地所有分支]  
git checkout -b newBranch [开发新功能的时候，开启新分支]  
git checkout branchWhichHas [切换到已存在分支]  
</code></pre><h6 id="合并分支操作："><a href="#合并分支操作：" class="headerlink" title="合并分支操作："></a>合并分支操作：</h6><pre><code>git checkout -b B [建立分支B]  
......开发新功能 并提交  
git checkout master [切换到master分支]  
git merge B [在master分支中把B分支更新合并过来]  
</code></pre><h6 id="本地变基"><a href="#本地变基" class="headerlink" title="本地变基"></a>本地变基</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git rebase B [把B分支中的修改以变基的方式合并到master分支中，以当前分支为基底，把B分支的修改逐一提交到当前分支]  </span><br><span class="line"></span><br><span class="line">注意点:变基能把提交历史记录变得清晰，便于管理和维护。但要遵守原则：一旦分支中的提交对象发布到公共仓库，就千万不要对该分支进行变基操作。因为变基修改推送到远程，别人同步后，会认为是一个新的提交，实际上内容没有变化。然后他需要合并这个提交才能继续开发，合并后会存在两份相同的提交历史。这个合并推送到服务器，会导致其他开发者不必要的疑惑。</span><br><span class="line"></span><br><span class="line">变基详细说明：</span><br><span class="line">https://git-scm.com/book/zh/v1/Git-%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E7%9A%84%E5%8F%98%E5%9F%BA</span><br></pre></td></tr></table></figure>
<h6 id="本地撤销操作"><a href="#本地撤销操作" class="headerlink" title="本地撤销操作"></a>本地撤销操作</h6><pre><code>git checkout -- filePath [工作区撤销单个文件修改] 
git checkout commitId filePath [单个文件回滚]  
git reset HEAD fineName  [暂存区撤销单个文件修改]   
git reset HEAD --hard commitid [本地回滚到版本号为commitid]   
git push origin HEAD --force [同步回滚远程版本]   
</code></pre><h6 id="如果不小心把问题代码同步到了远程，为了不影响其他人开发，可考虑强制回滚代码。"><a href="#如果不小心把问题代码同步到了远程，为了不影响其他人开发，可考虑强制回滚代码。" class="headerlink" title="如果不小心把问题代码同步到了远程，为了不影响其他人开发，可考虑强制回滚代码。"></a>如果不小心把问题代码同步到了远程，为了不影响其他人开发，可考虑强制回滚代码。</h6><pre><code>git reset HEAD commitID  [1.本地问题版本先回滚 ]
git push -f   或者 git push --force [2.把本地代码强制同步远程]
或
git revert  [撤销上一次提交]
或
如果要回滚到较远的版本，比较暴力的方法：拉取一份新副本，手动把改动的新代码覆盖到新副本并提交。
参考：
https://blog.csdn.net/fuchaosz/article/details/52170105
</code></pre><h6 id="对于单次commit操作的再修改"><a href="#对于单次commit操作的再修改" class="headerlink" title="对于单次commit操作的再修改"></a>对于单次commit操作的再修改</h6><pre><code>可以继续add 文件 并执行git commit  --amend [合并上次提交为本次提交]   
</code></pre><h6 id="冲突处理"><a href="#冲突处理" class="headerlink" title="冲突处理"></a>冲突处理</h6><pre><code>修改冲突文件后再次执行add、commit操作   
</code></pre><h6 id="log-查询"><a href="#log-查询" class="headerlink" title="log 查询"></a>log 查询</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git log   </span><br><span class="line">git log --author=authorName [指定提交人]</span><br><span class="line">git log --pretty=oneline [单行显示log信息]   </span><br><span class="line"></span><br><span class="line">log更多用法：</span><br><span class="line">https://git-scm.com/book/zh/v1/Git-%E5%9F%BA%E7%A1%80-%E6%9F%A5%E7%9C%8B%E6%8F%90%E4%BA%A4%E5%8E%86%E5%8F%B2</span><br></pre></td></tr></table></figure>
<p>彩蛋存送门：<a href="https://git-scm.com/download/gui/mac" target="_blank" rel="noopener">https://git-scm.com/download/gui/mac</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-03-21-0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-03-21-0.html" itemprop="url">算法-两个有序数组找交集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-21T00:00:00+08:00">
                2018-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-03-21-0.html" class="leancloud_visitors" data-flag-title="算法-两个有序数组找交集">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,162
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> 有两个长度分别为m,n的升序数组,其中n&gt; m*m,求这两个数组的交集,要求其复杂度尽可能低。<br> 如：<br> 数组a :-10,6,7<br> 数组b:-15,1,3,4,5,6,7,8,9,10,15<br> 输出：6，7</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1690665-6539524f70453f4b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="时间复杂度对比曲线.png"></p>
<p><strong>思路分析</strong>：最直接的思路，两层循环嵌套，找出两者的交集。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void intersection0(int *a,int lenA,int *b,int lenB)</span><br><span class="line">&#123;</span><br><span class="line">    for (int i = 0 ; i &lt; lenA; i ++) &#123;</span><br><span class="line">         int num = *(a + i);</span><br><span class="line">        for (int j = index ; j &lt; lenB; j ++) &#123;</span><br><span class="line">            int temp = *(b + j);</span><br><span class="line">            if (num == temp) &#123;</span><br><span class="line">                printf(&quot;%d &quot;,num);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>时间复杂度分析：</strong><br>最好的情况为：m + （1 + 2 + … + m = m + m^2 /2+m/2  渐进为m^2 ;<br>最坏的情况为：m + m <em>(m </em>m) =  m^3 +m ；渐进为m^3；<br>平均复杂度为：m^3</p>
<p><strong>优化：</strong><br>由于本身是一个升序的数列，当第一个元素查找到的时候，其下标为index，那么把index+1作为下一个元素的查找起始下标；如果第一个元素没有找到，记录B数组第一个比他大的元素的index作为下一个元素的查找起始下标。通过把查找范围不断缩小，查找的效率就会有所提高。优化后的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void intersection0(int *a,int lenA,int *b,int lenB)</span><br><span class="line">&#123;</span><br><span class="line">    for (int i = 0 ; i &lt; lenA; i ++) &#123;</span><br><span class="line">        int num = *(a + i);</span><br><span class="line">        int index = 0;</span><br><span class="line">        for (int j = index ; j &lt; lenB; j ++) &#123;</span><br><span class="line">            int temp = *(b + j);</span><br><span class="line">            if (num == temp) &#123;</span><br><span class="line">                index = j + 1;//记录下标，作为下一元素的起始查找下标。</span><br><span class="line">                printf(&quot;%d &quot;,num);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (temp &gt; num)</span><br><span class="line">            &#123;</span><br><span class="line">                index = j;//记录下标，作为下一元素的起始查找下标。</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>优化后的时间复杂度分析：</strong><br>最好的情况为：m + m = 2m  渐进为m；<br>最坏的情况为：m + 1 + 2+ 3…+ m 渐进为 m^2 ；<br>平均时间复杂度为：m^2  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//另外一种写法,时间复杂度跟上面的一样</span><br><span class="line">void intersection1(int *a,int len0,int *b,int len1)</span><br><span class="line">&#123;</span><br><span class="line">    int i ,j;</span><br><span class="line">    i = 0;</span><br><span class="line">    j = 0;</span><br><span class="line">    while (i &lt;= len0 - 1 &amp;&amp; j &lt;= len1 - 1) &#123;</span><br><span class="line">        if (*(a + i) == *(b + j)) &#123;</span><br><span class="line">            i ++;</span><br><span class="line">            j ++;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (*(a + i) &gt; *(b + j))</span><br><span class="line">        &#123;</span><br><span class="line">            j ++;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            i ++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="分析与改进"><a href="#分析与改进" class="headerlink" title="分析与改进"></a>分析与改进</h4><p>可见上面的算法都是m的平方阶或立方阶，并不理想。因为a数组遍历是必须的，问题就转变为提高在b数组中查找效率。复杂度计算应该为m(??)这样的形式，可不可以实现m(logm)这样的线性对数阶呢。比较简单的是使用二分查找。同时为了在查找的过程中不断收窄比较范围，使用双向间隔查找的方式。</p>
<p>具体过程：<br>先查找a[0]并收窄查找下限，然后查找a[lenA - 1- 0]并收窄查找上限，然后进入下一轮。另外b数组的元素分布比较均匀的话，可以使用<strong>插值查找</strong>，效率会比二分法高不少。插值查找关键步骤mid = low + (height - low ) *(key - b[low])/(b[height]-b[low] )。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">void intersection(int *a,int len0,int *b,int len1)</span><br><span class="line">&#123;</span><br><span class="line">    int low = 0;</span><br><span class="line">    int height = len1 - 1;</span><br><span class="line">    </span><br><span class="line">    int tempLow = low;</span><br><span class="line">    int tempHeight = height;</span><br><span class="line">    </span><br><span class="line">    int mid;</span><br><span class="line">    </span><br><span class="line">    //双向间隔遍历查找</span><br><span class="line">    for (int i = 0 ; i &lt;= len0/2; i ++) &#123;</span><br><span class="line">        </span><br><span class="line">        //如果是同于个元素结束,考虑i执行了++，就是上轮的右边等于当前的左边</span><br><span class="line">        if(i == len0  - i)</span><br><span class="line">        &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        low = tempLow;</span><br><span class="line">        height = tempHeight;</span><br><span class="line">        mid = (low + height)/2;</span><br><span class="line">        //左边开始查找,并调整下限</span><br><span class="line">        int  num = *(a + i);</span><br><span class="line">        while (height &gt;= low) &#123;</span><br><span class="line">             printf(&quot;mid %d\n&quot;,mid);</span><br><span class="line">            int temp = *(b + mid);</span><br><span class="line">            if (num == temp) &#123;</span><br><span class="line">                tempLow = mid;//调整下限</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (low == height)</span><br><span class="line">            &#123;</span><br><span class="line">                tempLow = mid;//调整下限</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (num &lt; temp)</span><br><span class="line">            &#123;</span><br><span class="line">                height = mid - 1;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                low = mid + 1;</span><br><span class="line">            &#125;</span><br><span class="line">            mid = (low + height)/2;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        printf(&quot;-------右边-----\n&quot;);</span><br><span class="line">        //如果是同于个元素结束</span><br><span class="line">        if(i == len0 - 1 - i)</span><br><span class="line">        &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        low = tempLow;</span><br><span class="line">        height = tempHeight;</span><br><span class="line">        mid = (low + height)/2;</span><br><span class="line">        //右边开始查找,并调整上限</span><br><span class="line">        int  num1 = *(a + len0 - 1 - i);</span><br><span class="line">        while (height &gt;=low) &#123;</span><br><span class="line">            int temp = *(b + mid);</span><br><span class="line">            if (num1 == temp) &#123;</span><br><span class="line">                tempHeight = mid;//调整上限</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (low == height)</span><br><span class="line">            &#123;</span><br><span class="line">                tempHeight = mid;//调整上限</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (num1 &lt; temp)</span><br><span class="line">            &#123;</span><br><span class="line">                height = mid - 1;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                low = mid + 1;</span><br><span class="line">            &#125;</span><br><span class="line">            mid = (low + height)/2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，这样输出的顺序也是间隔的。所以，如果要求输出是升序的话，这个输出的时候就要处理下，左边遍历的可以马上输出，右边遍历的需要存储起来，处理结束后，再顺序输出。</p>
<p>参考资料：<br>插值查找:<br><a href="https://blog.csdn.net/wangyunyun00/article/details/23464359" target="_blank" rel="noopener">https://blog.csdn.net/wangyunyun00/article/details/23464359</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-03-17-1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-03-17-1.html" itemprop="url">github page 域名绑定、域名设置https配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-16T00:00:00+08:00">
                2018-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/swift/" itemprop="url" rel="index">
                    <span itemprop="name">swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-03-17-1.html" class="leancloud_visitors" data-flag-title="github page 域名绑定、域名设置https配置">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  334
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近搭建了个人博客，网上教程很多，最后选择使用github page + 个人域名 + 配置https的方案。<br>主要参考：<a href="http://beiyuu.com/github-pages" target="_blank" rel="noopener">http://beiyuu.com/github-pages</a></p>
</blockquote>
<h3 id="一、域名与github-page-的配置问题。"><a href="#一、域名与github-page-的配置问题。" class="headerlink" title="一、域名与github page 的配置问题。"></a>一、域名与github page 的配置问题。</h3><h4 id="fork模板仓库后，在git端需要进行三步配置："><a href="#fork模板仓库后，在git端需要进行三步配置：" class="headerlink" title="fork模板仓库后，在git端需要进行三步配置："></a>fork模板仓库后，在git端需要进行三步配置：</h4><ol>
<li><p>CNAME文件修改【内容必须为一行】<br><img src="/personImg/CNAME配置.png" alt="CNAME配置.png"></p>
</li>
<li><p>修改仓库名称为：userName.github.io，此为github page要求的命名方式。<br><img src="/personImg/配置名称.jpeg" alt="配置名称.jpeg"></p>
</li>
<li><p>进入仓库setting进行设置。<br><img src="/personImg/git端域名配置.jpeg" alt="git端域名配置.jpeg"></p>
</li>
</ol>
<h3 id="域名解析配置中需要配置ip地址："><a href="#域名解析配置中需要配置ip地址：" class="headerlink" title="域名解析配置中需要配置ip地址："></a>域名解析配置中需要配置ip地址：</h3><p><em>分两步</em></p>
<ol>
<li><p>获取github page的ip地址。<br><img src="/personImg/githubPageIpAdress.png" alt="githubPageIpAdress.png"></p>
</li>
<li><p>配置域名解析【这里使用的是阿里云的域名，其他的域名配置应该是类似的。更新后大概需要10分钟左右才能生效】<br><img src="/personImg/dominSetting.png" alt="dominSetting.png"></p>
</li>
</ol>
<p>两者都没配好的时候，访问userName.github.io时可能会跳转到github的404页面。如果两者都对应ip地址配置好的，清空本地缓存并多刷新访问，有可能页面缓存或dns缓存没刷新。</p>
<h3 id="二、github-page-不支持证书绑定，通过dns代理跳转实现。"><a href="#二、github-page-不支持证书绑定，通过dns代理跳转实现。" class="headerlink" title="二、github page 不支持证书绑定，通过dns代理跳转实现。"></a>二、github page 不支持证书绑定，通过dns代理跳转实现。</h3><p>具体参考：<a href="https://segmentfault.com/a/1190000007740693" target="_blank" rel="noopener">https://segmentfault.com/a/1190000007740693</a><br>与教程中不同的是，新版的page rule有所不同，没有了always use Https这个配置了，忽略即可。</p>
<p>相关资源参考：<br>//主流程<br><a href="http://beiyuu.com/github-pages" target="_blank" rel="noopener">http://beiyuu.com/github-pages</a><br>//https配置<br><a href="https://segmentfault.com/a/1190000007740693" target="_blank" rel="noopener">https://segmentfault.com/a/1190000007740693</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-03-17-0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-03-17-0.html" itemprop="url">初入swift-常量变量、可选类型、可选绑定、隐式解析可选类型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-14T00:00:00+08:00">
                2018-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/swift/" itemprop="url" rel="index">
                    <span itemprop="name">swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-03-17-0.html" class="leancloud_visitors" data-flag-title="初入swift-常量变量、可选类型、可选绑定、隐式解析可选类型">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  998
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最早接触swift的时候是swift2.0，现在已经到了swift4.0了。可惜的是项目中一直没有机会使用swift，但最近回顾swift的时候发现swift确实有很多优点。swift是一门强类型的语言，它有类型推断、它的语法提供尽量精简的表达方式，闭包的形式一简再简，化繁为简。<br>例如：类型推断，因为你给变量赋值了，那么其实你的类型就是变量的类型，我能根据已有的信息推断出需要的信息。</p>
</blockquote>
<p>为了更好的加深对swift的印象，从语法入手，对比oc，并做总结。 </p>
<h4 id="一-swift只有常量和变量。"><a href="#一-swift只有常量和变量。" class="headerlink" title="一.swift只有常量和变量。"></a>一.swift只有常量和变量。</h4><p>声明变量用var，常量用let，如果一个值不需要变化的话，那么就把它声明为常量。无论是常量和变量在使用前都必须初始化，否则会编译报错。 </p>
<pre><code>//swift不需要添加“;”,系统自动识别
let item0 = 1  //系统自动推断出类型为int
let item1:Int = 1 //注明类型  
var item2 = 1
var item3:String = &quot;hello swift&quot;
</code></pre><p>具备oc没有的类型推断，起到简化代码的效果。同时它隐含着对开发者的要求，要清楚自己赋值的变量类型。  </p>
<h4 id="二-可选类型"><a href="#二-可选类型" class="headerlink" title="二.可选类型"></a>二.可选类型</h4><p>swift提供可选类型来处理值存在缺失的情况。例如你定义一个常量，如果在它的使用期间有可能会为空，那么就有必要把这个常量定义为可选类型。</p>
<pre><code>var item:Int?  //定义为可选类型。没有显式赋值，默认赋值为nil
</code></pre><p>swift真机智，又提醒开发者需要搞清楚这个变量会不会存在缺失。</p>
<p>更机智的是，你使用这个值的时候也要考虑几种情况。</p>
<ol>
<li><p>当不清楚它是否有值的情况下，获取它的时候可以直接使用变量名，例如print(item)</p>
</li>
<li><p>当明确知道它有值的情况下，使用强制解析（变量后面添加！），如print(item!)。但是如果这个值为nil，使用tiem！就会出现异常。</p>
</li>
</ol>
<p>然后为了区分这两种情况，可以通过if进行判断，这里又有一个叫做<strong>可选绑定</strong>的概念。</p>
<pre><code>var item：Int？ 
//普通的if判断
if item != nil
{
  print(tiem!)
}
else
{
//不操作，反正是为nil
}

//可选绑定
//temp只做输出作用，如果item赋值给temp有值，那么进入第一个分支，temp只做输出作用，不需要再进行强制解析。
if let temp = item
{
  print(temp)
}
else
{

}
</code></pre><p>从语法的角度来分析，要避免使用item！且item = nil 的情况，因为这种情况会导致程序崩溃。但是从swfit的设计思想和开发者的角度来看，要更清楚每个常量变量的作用、生命周期会不会存在为空的情况等。使用强制解析的时候，必须确保有值。</p>
<h4 id="三、相对可选类型，另外有一个隐式解析可选类型"><a href="#三、相对可选类型，另外有一个隐式解析可选类型" class="headerlink" title="三、相对可选类型，另外有一个隐式解析可选类型"></a>三、相对可选类型，另外有一个隐式解析可选类型</h4><p>如果你总能确定这个常量在它的生命周期中一定有值，那么就没有必要每次都进行if判断或者可选绑定，这样是非常低效的。直接把类型定义为隐式解析可选类型。<br>形如：  </p>
<pre><code>//可选绑定
var item0:Int? = 1
let temp0 =  item0!

//隐士解析可选绑定，问号变成感叹号
var item1:Int! = 1
//直接解析，不需要感叹号
let temp1 = item1
</code></pre><p><strong>小结</strong><br>通过分析可选类型、可选绑定、隐式解析可选类型、变量的获取等用法，去思考下swift为什么要这么设计。能感觉到swift尽量通过语法层面的东西，对开发者有更高的要求，至少在编码的层面要更清楚自己定义的每一个东西，它的作用是怎么样的，会存在什么情况，使用的时候的状态是有值还是没值等等。</p>
<p>待续~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-03-17-4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-03-17-4.html" itemprop="url">iOS 网络数据-减少重复的字典取值操作、直接获取目的字段</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-22T00:00:00+08:00">
                2018-02-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/net-data/" itemprop="url" rel="index">
                    <span itemprop="name">net data</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-03-17-4.html" class="leancloud_visitors" data-flag-title="iOS 网络数据-减少重复的字典取值操作、直接获取目的字段">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,165
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>当我们处理接口数据的时候，有些情况仅仅需要获取一个或多个字段，来进行状态判断或数据显示。在写这部分代码的时候，或多或少会有一种重复感，但它又不是一成不变的重复，而是其模式相同，大量的字典取值操作，又或者多层的字典取值。这里能否实现一个功能，减少重复操作，一步到位，又或者提高下效率，让这部分代码逻辑变得简洁统一。我想可以自己定义一个取值协议，通过这个协议对数据进行解析，获取目的字段。这样就方便多了，只要根据协议解析就就可以省去很多重复操作。</p>
</blockquote>
<h5 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h5><p>获取到后台数据的时候，接口回调回来的是一个字典对象，如果不是，那么需要进行一层处理转换成字典对象。然后，我们只需要对这个字典对象一层一层的解析，直到获取并返回目的字段的值。在解析的过程中，添加必要的健壮性处理，如果无法满足下一步解析的条件，结束解析并返回错误信息。</p>
<h5 id="协议设定"><a href="#协议设定" class="headerlink" title="协议设定"></a>协议设定</h5><p>传入特定结构的字符串作为解析的依据。而这个字符串的结构规则就是协议的内容。</p>
<ol>
<li>把”{“作为字典类型的标记</li>
<li>把”[“作为数组类型的标记</li>
<li>在”{“、”[“前添加各自的字段名keyName</li>
<li>由左到右解析</li>
</ol>
<p>例如：@”keyName0{KeyName1{dstKeyName{“<br>第一层字段名为keyName0，类型为字典，所以先解析出一个字典对象value0。通过value0和第二层字段名KeyName1，解析出一个value1。如此类推，通过value1获取目的字段dstKeyName的值dstValue。<br>其正确的数据结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;keyName0&quot;:&#123;</span><br><span class="line">        &quot;KeyName1&quot;:&#123;</span><br><span class="line">            &quot;dstKeyName&quot;:&#123;</span><br><span class="line">               //keys &amp; values</span><br><span class="line">              &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><p>能获取下一层的必须是一个字典对象，就是说协议字符串目的字段之前所有字段的类型标记都为”{“。还有一点，我们可以在目的字段后面添加类型标记，这样的话，就可以根据这个类型标记来判断目的字段的值的类型是否与期待的一致。可以添加NSString、NSNumber类型的符号如NSString对应@，Number对应$等，约定好添加逻辑处理即可。</p>
<p>测试代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">NSString *path = [[NSBundle mainBundle]pathForResource:@&quot;json&quot; ofType:@&quot;txt&quot;];</span><br><span class="line">    NSString *jsonString = [[NSString alloc]initWithContentsOfFile:path encoding:NSUTF8StringEncoding error:nil];</span><br><span class="line">    NSData *jsonData = [jsonString dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    NSError *jsonError = nil;</span><br><span class="line">    NSDictionary *testDictionary = [NSJSONSerialization JSONObjectWithData:jsonData options:NSJSONReadingMutableContainers error:&amp;jsonError];</span><br><span class="line">    if (jsonError) &#123;</span><br><span class="line">        NSLog(@&quot;error0：%@ &quot;,jsonError);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSNumber *status = [SafeDataProcessor getObjectWithFormmateString:@&quot;data&#123;status&quot; data:testDictionary];</span><br><span class="line">    //直接获取page字段</span><br><span class="line">    NSNumber *page = [SafeDataProcessor getObjectWithFormmateString:@&quot;data&#123;result&#123;all_page&quot; data:testDictionary];</span><br><span class="line">    </span><br><span class="line">    //先获取result字段，再获取list字段</span><br><span class="line">    NSDictionary *result = [SafeDataProcessor getObjectWithFormmateString:@&quot;data&#123;result&#123;&quot; data:testDictionary];</span><br><span class="line">    NSArray *list = [SafeDataProcessor getObjectWithFormmateString:@&quot;list[&quot; data:result];</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;\n statu:%@,\n page:%@,\n list:%@,\n result:%@,\n &quot;,status,page,list,result);</span><br></pre></td></tr></table></figure></p>
<p>调试结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">2018-02-22 10:57:25.093365+0800 SafeNetDataProcessor[2882:123596] </span><br><span class="line"> statu:200,</span><br><span class="line"> page:20,</span><br><span class="line"> list:(</span><br><span class="line">        &#123;</span><br><span class="line">        &quot;check_reply_info&quot; =         &#123;</span><br><span class="line">            num = 6;</span><br><span class="line">            type = 1;</span><br><span class="line">        &#125;;</span><br><span class="line">        content = &quot;\U5b66\U4e60\U4e0d\U662f\U7ed9\U8001\U5e08\U5b66\U7684\Uff0c\U662f\U7ed9\U4f60\U81ea\U5df1\U5b66\U7684\U3002&quot;;</span><br><span class="line">        &quot;create_time&quot; = 1518361773;</span><br><span class="line">        floor = 1;</span><br><span class="line">        groupid = &quot;-1&quot;;</span><br><span class="line">        &quot;light_count&quot; = 1992;</span><br><span class="line">        pid = 259696;</span><br><span class="line">        puid = 25941704;</span><br><span class="line">        quote =         (</span><br><span class="line">        );</span><br><span class="line">        &quot;quote_deleted&quot; = 0;</span><br><span class="line">        smallcontent = &quot;\U5b66\U4e60\U4e0d\U662f\U7ed9...&quot;;</span><br><span class="line">        time = &quot;8\U5c0f\U65f6\U524d&quot;;</span><br><span class="line">        togglecontent = &quot;&quot;;</span><br><span class="line">        &quot;update_info&quot; = 0;</span><br><span class="line">        userImg = &quot;http://i1.hoopchina.com.cn/user/665/256623943989665/256623943989665-1518360162.jpeg@45h_45w_2e&quot;;</span><br><span class="line">        userName = &quot;\U4e8c\U53f7\U8001\U6d41\U6c13&quot;;</span><br><span class="line">        &quot;user_banned&quot; = 0;</span><br><span class="line">        via = 9;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure></p>
<h5 id="功能的优缺点分析"><a href="#功能的优缺点分析" class="headerlink" title="功能的优缺点分析"></a>功能的优缺点分析</h5><p>优点：这个功能的优点很明显，就是把分散的处理集中了，输入结构字符串和网络返回值，即可获取目的字段的值，中间的健壮性处理和取值操作都可以省掉了，从这个角度看，减少了编码工作，提高了效率；同时，统一的健壮性处理，只要保证内部处理正确稳定，那么该部分处理就是稳定安全的。对比原来，每次都要手写一次，难保每次都是正确的，特别拷贝大段代码进行修改，这样的操作容易出现低级错误。</p>
<p>缺点：根据字符串来解析，所以会有额外的字符串操作处理，使程序的执行效率变低。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>从程序运行的角度来看，效率最高的的固然是最贴近需求，无多余操作的代码。但从软件开发的角度来看，程序本身执行效率很重要，但是程序健壮性、编码效率和编码质量也同样重要。</p>
<p>demo地址:<br><a href="https://github.com/zmubai/SafeDataProcessor" target="_blank" rel="noopener">https://github.com/zmubai/SafeDataProcessor</a></p>
<p>end~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-03-17-3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-03-17-3.html" itemprop="url">iOS 网络数据处理技巧，提高程序健壮性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-19T00:00:00+08:00">
                2018-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/net-data/" itemprop="url" rel="index">
                    <span itemprop="name">net data</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-03-17-3.html" class="leancloud_visitors" data-flag-title="iOS 网络数据处理技巧，提高程序健壮性">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  874
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作为一名移动开发者，免不了跟网络数据打交道。在需求开发的过程中，我们会通过接口文档约定好前后端交互的数据结构，基于这个，我们能顺利地实现前端的数据交互，顺利的把数据送往后台。如果我们严格遵守双方约定，就可以大大的减少数据问题。但是，数据这东西无法保证百分百准确，为了避免数据错误导致更大的程序错误，我们必须对数据做严格校验，从而保证程序的健壮性。</p>
</blockquote>
<pre><code>/*
//示例数据结构：
{
    &quot;data&quot;:{
        &quot;status&quot;:200,
        &quot;result&quot;:{
            &quot;list&quot;:Array[20],
            &quot;all_page&quot;:20
        }
    },
    &quot;status&quot;:0
}
*/
</code></pre><h3 id="网络数据健壮性处理"><a href="#网络数据健壮性处理" class="headerlink" title="网络数据健壮性处理"></a>网络数据健壮性处理</h3><h5 id="逐层判断"><a href="#逐层判断" class="headerlink" title="逐层判断"></a>逐层判断</h5><p>从外到里一层一层的判断，确保每一步操作成功了才进行下一步操作。</p>
<pre><code>+ (NSDictionary *)resultWithResponseDictionary:(NSDictionary*)responseDictionary
{
    NSAssert([responseDictionary isKindOfClass:[NSDictionary class]], @&quot;responseDictionary should be dictionary class&quot;);

    if (![responseDictionary isKindOfClass:[NSDictionary class]]) return nil;

    NSDictionary *data = [responseDictionary valueForKey:@&quot;data&quot;];
    if (![data isKindOfClass:[NSDictionary class]])  return nil;

    NSDictionary *result = [data valueForKey:@&quot;result&quot;];
    if (![result isKindOfClass:[NSDictionary class]]) {
        return nil;
    }
    else
    {
        return result;
    }
}

+ (NSArray *)getListWithResponseDictionary:(NSDictionary*)responseDictionary
{
    NSDictionary *result = [self resultWithResponseDictionary:responseDictionary];

    NSArray *list  = [result valueForKey:@&quot;list&quot;];

    return [list isKindOfClass:[NSArray class]]?list:nil;
}
</code></pre><h5 id="字段类型判断"><a href="#字段类型判断" class="headerlink" title="字段类型判断"></a>字段类型判断</h5><p>因为OC是动态语言，对象的真实类型在运行的时候才能确定，如果不添加类型判断，在网络数据处理的场景下，可能会出现对象真实类型与期待类型不一致的情况，导致方法调用失败，程序异常崩溃。例如，预期的是一个NSString对象，调用了NSString类独有的substringFromIndex方法，运行的时候却是一个NSNumber对象，继续调用substringFromIndex方法，就会产生一个运行时崩溃。另一种情况，调用的是共同父类的方法 ，NSNumber对象执行方法不会发生异常，但这时程序已经存在风险了，因为对象类型已经不符程序预期。可通过- (BOOL)isKindOfClass:(Class)aClass对类型进行判断。</p>
<h5 id="非空判断"><a href="#非空判断" class="headerlink" title="非空判断"></a>非空判断</h5><p>空对象调用方法是不会产生异常的，而操作空对象就可能出现异常，例如数组操作、字典操作等。如：</p>
<pre><code>//测试代码
 NSMutableDictionary *dic = @{}.mutableCopy;
    [dic setObject:nil forKey:@&quot;age&quot;];

异常：
*** Terminating app due to uncaught exception &apos;NSInvalidArgumentException&apos;, reason: &apos;*** -[__NSDictionaryM setObject:forKey:]: object cannot be nil (key: age)&apos;

//测试代码
  [@[].mutableCopy addObject:nil];

异常：
*** Terminating app due to uncaught exception &apos;NSInvalidArgumentException&apos;, reason: &apos;*** -[__NSArrayM insertObject:atIndex:]: object cannot be nil&apos;
</code></pre><p>为了避免类似的问题，需要在操作对象前添加必要的非空判断。</p>
<h5 id="单个字段逻辑合法性判断"><a href="#单个字段逻辑合法性判断" class="headerlink" title="单个字段逻辑合法性判断"></a>单个字段逻辑合法性判断</h5><p>对于一些有意义的字段，这些字段有其合法的取值区间，那么操作该数据时需要先判断其数据是否合法，例如：年龄age， 其合法性校验age&gt;0 。</p>
<h5 id="字段间逻辑合法性判断"><a href="#字段间逻辑合法性判断" class="headerlink" title="字段间逻辑合法性判断"></a>字段间逻辑合法性判断</h5><p>有一些字段之间存在逻辑关系，特别是提交数据给后台的时候，我们更需要在提交之前做一次数据间逻辑合法性的校验。如 x、y、z字段之间有如下关系：z = 2x + y。那么提交数据前就需要判断下其是否符逻辑z = 2x + y。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>1、2、3点在网络数据处理中是非常有必要的，而4、5点加强了对数据逻辑的校验，更加贴近业务。同时，4、5点一般采取断言的方式进行处理。在开发测试的过程中，如果存在问题，我们期待通过断言及时发现问题。</p>
<p>end~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zengbailiang.cn/2018-03-17-5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zengbailiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沐白的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018-03-17-5.html" itemprop="url">iOS m3u8本地缓存播放(控制下载并发、暂停恢复)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T00:00:00+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/m3u8/" itemprop="url" rel="index">
                    <span itemprop="name">m3u8</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018-03-17-5.html" class="leancloud_visitors" data-flag-title="iOS m3u8本地缓存播放(控制下载并发、暂停恢复)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,402
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">目录</span><br><span class="line">一、m3u8缓存播放的整个流程</span><br><span class="line">二、控制媒体下载的并发数</span><br><span class="line">三、控制单个媒体的切片下载并发数</span><br><span class="line">四、下载的中断和恢复</span><br><span class="line">五、注意的问题与思路延伸</span><br></pre></td></tr></table></figure>
<h3 id="一、m3u8缓存播放的整个流程"><a href="#一、m3u8缓存播放的整个流程" class="headerlink" title="一、m3u8缓存播放的整个流程"></a>一、m3u8缓存播放的整个流程</h3><ol>
<li>下载m3u8文件</li>
<li>解析m3u8文件获取视频切片单元的信息。</li>
<li>根据2.获取的视频切片信息中的切片链接下载切片并保持到本地。</li>
<li>根据获取的切片信息与本地服务器的配置信息，拼接出切片的本地地址、生成新的m3u8文件并保存到本地。</li>
<li>开启本地服务器，使用本地url播放本地m3u8文件。</li>
</ol>
<p>附上：时序图，具体可看demo</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1690665-3f245e01576dfac2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="二、控制媒体下载的并发数"><a href="#二、控制媒体下载的并发数" class="headerlink" title="二、控制媒体下载的并发数"></a>二、控制媒体下载的并发数</h3><pre><code>这里使用信号量来控制并发数
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (void)downloadVideoWithUrlString:(NSString *)urlStr downloadProgressHandler:(ZBLM3u8ManagerDownloadProgressHandler)downloadProgressHandler downloadSuccessBlock:(ZBLM3u8ManagerDownloadSuccessBlock) downloadSuccessBlock</span><br><span class="line">&#123;</span><br><span class="line">    dispatch_async(_downloadQueue, ^&#123;</span><br><span class="line">        dispatch_semaphore_wait(_movieSemaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        __weak __typeof(self) weakself = self;</span><br><span class="line">        [[self downloadContainerWithUrlString:urlStr] startDownloadWithUrlString:urlStr  downloadProgressHandler:^(float progress) &#123;</span><br><span class="line">            downloadProgressHandler(progress);</span><br><span class="line">        &#125; completaionHandler:^(NSString *locaLUrl, NSError *error) &#123;</span><br><span class="line">            if (!error) &#123;</span><br><span class="line">                [weakself.downloadContainerDictionary removeObjectForKey:[ZBLM3u8Setting uuidWithUrl:urlStr]];</span><br><span class="line">                NSLog(@&quot;下载完成:%@&quot;,urlStr);</span><br><span class="line">                downloadSuccessBlock(locaLUrl);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                NSLog(@&quot;下载失败:%@&quot;,error);</span><br><span class="line">                [self resumeDownload];</span><br><span class="line">            &#125;</span><br><span class="line">            NSLog(@&quot;%@&quot;,weakself.downloadContainerDictionary.allKeys);</span><br><span class="line">            dispatch_semaphore_signal(_movieSemaphore);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>//这里可以设置_movieSemaphore的的初始值为具体的可同时下载数。Example:_movieSemaphore = dispatch_semaphore_create(1),意味着同一时间只允许下载一个视频，等同于视频的串行下载。
</code></pre><h3 id="三、控制单个媒体的切片下载并发数"><a href="#三、控制单个媒体的切片下载并发数" class="headerlink" title="三、控制单个媒体的切片下载并发数"></a>三、控制单个媒体的切片下载并发数</h3><pre><code>开始的时候，考虑使用AFURLSessionManager中的operationQueue.maxConcurrentOperationCount来控制并发。但这是行不通的。因为这个queue是用于回调而不是用于下载队列。
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> The operation queue on which delegate callbacks are run.</span><br><span class="line"> */</span><br><span class="line">@property (readonly, nonatomic, strong) NSOperationQueue *operationQueue;</span><br></pre></td></tr></table></figure>
<p>再看AF中初始化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithSessionConfiguration:(NSURLSessionConfiguration *)configuration &#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (!self) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!configuration) &#123;</span><br><span class="line">        configuration = [NSURLSessionConfiguration defaultSessionConfiguration];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self.sessionConfiguration = configuration;</span><br><span class="line"></span><br><span class="line">    self.operationQueue = [[NSOperationQueue alloc] init];</span><br><span class="line">    self.operationQueue.maxConcurrentOperationCount = 1;</span><br><span class="line"></span><br><span class="line">    self.session = [NSURLSession sessionWithConfiguration:self.sessionConfiguration delegate:self delegateQueue:self.operationQueue];</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<pre><code>这个queue确实是用于回调，而我是需要控制下载并发。这似乎不满足。而且实测中也发现确实不行。那么，只能在任务发起哪里做并发控制，同样，这里还是采用信号量。这里的控制相对复杂一点、因为后面的任务恢复、失败任务重新创建也要做控制。
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (void)startDownload</span><br><span class="line">&#123;</span><br><span class="line">    //因为这是外部调用的方法，操作的执行要放到异步线程中。避免因为并发控制中的等待而堵塞外部线程</span><br><span class="line">    dispatch_async(self.downloadQueue, ^&#123;</span><br><span class="line">        if (!_fileDownloadInfos.count) &#123;</span><br><span class="line">            _completaionHandler(nil);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        NSLog(@&quot;downloadInfoCount:%ld&quot;,(long)_fileDownloadInfos.count);</span><br><span class="line">        </span><br><span class="line">        [_fileDownloadInfos enumerateObjectsUsingBlock:^(ZBLM3u8FileDownloadInfo * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">            //控制切片下载并发</span><br><span class="line">            dispatch_semaphore_wait(self.tsSemaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">            if ([ZBLM3u8FileManager exitItemWithPath:obj.filePath]) &#123;</span><br><span class="line">                obj.success = YES;</span><br><span class="line">                [self verifyDownloadCountAndCallbackByDownloadSuccess:YES];</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                //如果收到中断信号，中断下载流程释放信号量并返回</span><br><span class="line">                if (self.suspend) &#123;</span><br><span class="line">                    obj.beStopCreateTask = YES;</span><br><span class="line">                    dispatch_semaphore_signal(self.tsSemaphore);</span><br><span class="line">                    NSLog(@&quot;suspend and return! don not createDownloadTask!&quot;);</span><br><span class="line">                    return ;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    //真正的创建下载任务</span><br><span class="line">                    [self createDownloadTaskWithIndex:idx];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//信号量在每个任务的回调后都会释放一次</span><br><span class="line">- (void)verifyDownloadCountAndCallbackByDownloadSuccess:(BOOL) isSuccess</span><br><span class="line">&#123;</span><br><span class="line">    dispatch_semaphore_signal(self.tsSemaphore);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li><p>这里也看到信号量的控制问题，必须理清信号量的获得和释放时机，一次获得必须有一次释放。不释放或者重复释放，都会导致并发的控制不准。如果这样，那这里的并发控制就没有意义了。</p>
</li>
<li><p>要做到准确获取和释放，重点在于理清程序的执行路径。在每一条执行路径中都必须释放信号量。这个跟锁的使用也是一样的。</p>
</li>
<li>调试现象：如果程序不像预料中运行，又没有什么错误，那很有可能就是堵塞了。锁没有释放或者信号量的处理有问题。<br>处理步骤：点击xcode调试栏的暂停按钮，查看程序的调用栈，分析每个线程的运行情况，找到堵塞具体执行代码。根据具体的逻辑修正问题。</li>
</ul>
<h3 id="四、下载的中断和恢复"><a href="#四、下载的中断和恢复" class="headerlink" title="四、下载的中断和恢复"></a>四、下载的中断和恢复</h3><pre><code>这里有几个小问题：根据判断NSURLSessionTask 提供的3个方法可以做一些中断和恢复处理
</code></pre><ul>
<li><p>(void)suspend;</p>
<pre><code>挂起任务，但只能挂起执行中的任务。对于已经创建而且执行resum方法但并没真正执行的任务无效（这里非常坑）。
</code></pre><p>通常我们使用这个方法的时候会判断下任务的具体状态，如果是task.state == NSURLSessionTaskStateRunning采取执行 [task suspend]。但这个判断是不准确的。如果一个任务创建并执行resume但并没真正执行，它的状态也是为NSURLSessionTaskStateRunning。如果这个时候程序收到中断消息，对状态为NSURLSessionTaskStateRunning 的任务全部执行suspend操作，你会发现有些任务不听话，继续执行。到底什么搞鬼…<br>我的理解是这样的，这些不听话的任务正是那些添加到下载队列中等待执行的任务，而在等待状态下收到suspend消息是不管用的。但它接收cannel消息是管用的。那么问题的解决就是找出这些等待的任务。<br>处理办法：通过判断接收字节数来区分状态。现在我只面向你接收的字节数，而不管你真开启还是假开启了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">switch (obj.downloadTask.state) &#123;</span><br><span class="line">                case NSURLSessionTaskStateRunning:</span><br><span class="line">                &#123;</span><br><span class="line">                    //等待中，假开启状态，</span><br><span class="line">                    if (obj.downloadTask.countOfBytesReceived &lt;= 0) &#123;</span><br><span class="line">                        [obj.downloadTask cancel];</span><br><span class="line">                    &#125;</span><br><span class="line">                    else</span><br><span class="line">                    &#123;</span><br><span class="line">                    //正在下载，真开启状态，</span><br><span class="line">                        [obj.downloadTask suspend];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br></pre></td></tr></table></figure>
<ul>
<li>(void)resume;<br>官方文档是这么说明的：Resumes the task, if it is suspended.意思是指只能发起被挂起的任务。<br>存在两种情况：<br>1.新创建的任务并没有执行resume，此时状态为：NSURLSessionTaskStateSuspended<br>2.执行suspend方法后被手动挂起的任务，状态同为NSURLSessionTaskStateSuspended。<br>同时这里提供了额外信息：状态为NSURLSessionTaskStateCompleted的任务是不能通过resume重新发起的。而在某些情况下我们需要对这种状态的任务重新发起，包括手动cannel的、执行失败的。这种情况下只能根据具体的情况，重新创建任务并发起。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (obj.downloadTask.error &amp;&amp; </span><br><span class="line">    obj.downloadTask.state == NSURLSessionTaskStateCompleted)</span><br><span class="line">&#123;</span><br><span class="line">              //下载失败的任务重新创建</span><br><span class="line">                [self createDownloadTaskWithIndex:idx];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>(void)cancel;<br>官方文档说明：</p>
<blockquote>
<p>This method returns immediately, marking the task as being canceled. Once a task is marked as being canceled, URLSession:task:didCompleteWithError: will be sent to the task delegate, passing an error in the domain NSURLErrorDomain with the code NSURLErrorCancelled. A task may, under some circumstances, send messages to its delegate before the cancelation is acknowledged.<br>This method may be called on a task that is suspended.</p>
</blockquote>
<p>简而言之：调用这个方法可以cannel任意状态的任务包括挂起的任务。并执行didCompleteWithError回调（AF中会执行回调并返回错误NSURLErrorCancelled），状态被标记为NSURLSessionTaskStateCompleted。故上面恢复失败任务的时候，通过task.state和task.error共同判断。</p>
</li>
</ul>
<h5 id="总结下任务生命周期中的任务状态变化："><a href="#总结下任务生命周期中的任务状态变化：" class="headerlink" title="总结下任务生命周期中的任务状态变化："></a>总结下任务生命周期中的任务状态变化：</h5><ol>
<li>创建成功：…Suspended</li>
<li>执行resume:…Running（可以通过判断countOfBytesReceived来区分任务处于等待还是下载中）</li>
<li>执行suspend：…Suspended</li>
<li>执行cannel：(中间状态…Canceling）-&gt;…Completed（可以结合task.error判断任务执行结果）</li>
</ol>
<h5 id="回归正题："><a href="#回归正题：" class="headerlink" title="回归正题："></a>回归正题：</h5><pre><code>视频单元的中断和恢复，中断就是调用suspend方法挂起正在执行的任务，cannel掉等待的任务，代码跟上面说明方法的时候非常雷同。这里着重说明下恢复。如果单单恢复其实很简单，恢复挂起的任务和重新创建错误的任务。这只是从程序的角度看待，要使一个程序有更高的可用性，应在功能实现的同时做的更加的合理。应优先恢复挂起的任务、然后重新创建错误的任务。这样做都是为了承前启后更快的把一个下载任务完成。而且这个视频切片是讲究有序的，所以我们恢复的时候也要遵从FIFO的原则。
</code></pre><h3 id="五、注意的问题与思路延伸"><a href="#五、注意的问题与思路延伸" class="headerlink" title="五、注意的问题与思路延伸"></a>五、注意的问题与思路延伸</h3><ol>
<li><p>解析m3u8注意的问题<br>   这里的解析格式太多，很容易出现问题，应使用try/catch来保证程序的健壮性。</p>
</li>
<li><p>根据url获取原始m3u8文件信息，这个操作太耗时了。为了提高程序的效率，获取到原始m3u8文件后应做本地持久化并用于二次下载。如果整个流程下载成功，可以选择删除该文件，或者不操作。由于是纯文本文件，少量的文件冗余是允许的。</p>
</li>
<li><p>文件的操作通过开启一个同步队列来处。可以设定low优先级避免占用太高的cpu资源。其实高cpu占用会伴随着另外一个问题，手机的发热量。</p>
</li>
<li><p>key的处理问题<br>   如果存在key的下载，需要把key下载到本地，约定好key的名称和新建m3u8文件中的key链接。这样本地播放就能正常加解密。<br>例如下载到本地的key保存为…/key。那么链接应该是http:localhost:port/…/key</p>
</li>
<li><p>中断的优先级<br>   程序的中断操作拥有最高优先级的，因为要任何状态下都能中断下载。无论是为了程序的流畅性、网络变为移动信号避免使用用户的移动流量等发出中断命令，都必须立即响应。</p>
</li>
<li><p>切片数量的全局分配<br>   多个视频同时下载，多个切片同时并发。如果要做到控制全局的切片并发数而不是单个视频的切片并发数。这就要设计一个算法在全局Manger哪里做分配和回收。</p>
</li>
<li><p>保证app流程，监控网速开启和中断下载<br>   下载视频的功能应该要保证app本身网络请求的正常运行。<br>app如何获取到网络的带宽，好像只能通过下载文件方式来推算。可在应用请求空闲时通过短时间下载一个可用源来计算带宽，同时监控app 实时网络吞吐，适当的开关下载。虽然很难做到实时，但是在切换网络的时候进行带宽重测、又或者地理位置变化一定距离后进行带宽重测、又或者定时作带宽重测。还有就是考虑wifi状态下才进行下载。</p>
</li>
<li><p>切换网络后请求失去连接，恢复下载的问题<br>   因为网络切换本地ip变化，发起的请求会失去连接。如果通过downloadTask是没办法做到恢复下载的。虽然可以用resumeData来恢复下载，但是这个只能在cannel操作的时候获取，至于失去连接的情况下是没办法获取到的（系统提供的api中没有在失败回调哪里返回resumeData的）。这个时候需要自己创建文件句柄，使用dataTask做到文件续下。初始化dataTask的时候设定请求头’Accept-Ranges’参数为文件的已下载字节数（需要服务器支持），就可以获取到未下载的部分数据。</p>
</li>
<li><p>并发中锁的处理<br>   要理清那些代码可能存在并发，那些操作要保证原子性。难就难在一个方法中会存在部分代码块是并发执行的，这有利于效率的提高；部分些代码要原子操作。最优的做法就是对原子操作用锁来保证，没有任何多余的代码加入到同步操作中，这样也是效率最高的。而拿捏不准的情况下，可以锁定更多的代码，至少这样不会因为并发而导致问题，但这样就牺牲了效率和及时性。当一个简单的系统，要做到最优好像并不难，但是一个复杂的系统做到最优就非常难了或者是要花费非常大的精力。</p>
</li>
<li><p>是否需要全部切片下载完成才能播放<br>  其实并不需要全部下载完成就能播放的。一个车子开起来只要保证后面的能源供应充足就能一直正常运作。首先保证key 先下载下来，而且要保证有序下载，然后下载一定量的切片文件，这个时候就可以组装m3u8文件到本地，发起播放。只要后面下载的切片能满足播放器的播放，就不会出现问题。但如果供应不足视频就会停了，播放不了，尽管后面文件下载下来了，还是不能自动恢复，仿佛失去了缓冲功能。这里就是跟直接请求服务器的差别了，直接请求服务器，因为文件本身是存在的，发起的请求是存在的，如果网速慢，播放器的反应是缓冲；而本地服务播放就不同了，如果文件在播放前没有下载下来，发起的请求立马就挂了，这个请求不存在，当然就不存在缓冲。</p>
</li>
<li><p>线程多开占用资源，每个线程占用512K到1M空间。建议使用单线程下载，且稳定性高。</p>
</li>
</ol>
<p>dome链接：<a href="https://github.com/zmubai/ZBLM3U8DownLoadTest" target="_blank" rel="noopener">https://github.com/zmubai/ZBLM3U8DownLoadTest</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/icon.jpg"
                alt="zengbailiang" />
            
              <p class="site-author-name" itemprop="name">zengbailiang</p>
              <p class="site-description motion-element" itemprop="description">知行合一</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a rel="external nofollow" href="/archives/">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zmubai" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zengbailiang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">46.7k</span>
  
</div>


  <div class="powered-by">由 <a rel="external nofollow" class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("7VSaCuGNNUXrDp0aOK65w7PQ-gzGzoHsz", "l1D8p6eriduqG6aqx1f8H7ia");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
